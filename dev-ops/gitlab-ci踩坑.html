<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gitlab-ci 踩坑 | 游离 の Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.1cdd1db5.css" as="style"><link rel="preload" href="/assets/js/app.301264ef.js" as="script"><link rel="preload" href="/assets/js/2.491aa157.js" as="script"><link rel="preload" href="/assets/js/34.65f27a2b.js" as="script"><link rel="prefetch" href="/assets/js/10.c14c6624.js"><link rel="prefetch" href="/assets/js/11.a9937c4e.js"><link rel="prefetch" href="/assets/js/12.b046b473.js"><link rel="prefetch" href="/assets/js/13.01aa47ff.js"><link rel="prefetch" href="/assets/js/14.f42daf23.js"><link rel="prefetch" href="/assets/js/15.fb6a03fc.js"><link rel="prefetch" href="/assets/js/16.3d6029c1.js"><link rel="prefetch" href="/assets/js/17.e7fd4a45.js"><link rel="prefetch" href="/assets/js/18.2eee2a30.js"><link rel="prefetch" href="/assets/js/19.c7a805c8.js"><link rel="prefetch" href="/assets/js/20.6ec04b81.js"><link rel="prefetch" href="/assets/js/21.d6a9c37a.js"><link rel="prefetch" href="/assets/js/22.d54975c6.js"><link rel="prefetch" href="/assets/js/23.dd01fe58.js"><link rel="prefetch" href="/assets/js/24.5b080a00.js"><link rel="prefetch" href="/assets/js/25.3e3a8a4d.js"><link rel="prefetch" href="/assets/js/26.530f08ad.js"><link rel="prefetch" href="/assets/js/27.4ff6770f.js"><link rel="prefetch" href="/assets/js/28.4772ab22.js"><link rel="prefetch" href="/assets/js/29.59c92581.js"><link rel="prefetch" href="/assets/js/3.2a78adba.js"><link rel="prefetch" href="/assets/js/30.8945c40e.js"><link rel="prefetch" href="/assets/js/31.71ea1936.js"><link rel="prefetch" href="/assets/js/32.242631cf.js"><link rel="prefetch" href="/assets/js/33.3096cd30.js"><link rel="prefetch" href="/assets/js/35.8a5e22fe.js"><link rel="prefetch" href="/assets/js/36.b8444b82.js"><link rel="prefetch" href="/assets/js/37.07333cdf.js"><link rel="prefetch" href="/assets/js/38.c9340582.js"><link rel="prefetch" href="/assets/js/39.86b27506.js"><link rel="prefetch" href="/assets/js/4.6c7e408b.js"><link rel="prefetch" href="/assets/js/40.3e8e0e91.js"><link rel="prefetch" href="/assets/js/41.4abf36b5.js"><link rel="prefetch" href="/assets/js/42.b93937ca.js"><link rel="prefetch" href="/assets/js/43.599a58a3.js"><link rel="prefetch" href="/assets/js/44.58c0ac23.js"><link rel="prefetch" href="/assets/js/45.a007e26f.js"><link rel="prefetch" href="/assets/js/46.9aebcd42.js"><link rel="prefetch" href="/assets/js/47.ac13be33.js"><link rel="prefetch" href="/assets/js/48.34e99078.js"><link rel="prefetch" href="/assets/js/49.195b0aef.js"><link rel="prefetch" href="/assets/js/5.82c6f654.js"><link rel="prefetch" href="/assets/js/50.964a51b7.js"><link rel="prefetch" href="/assets/js/51.b0b85444.js"><link rel="prefetch" href="/assets/js/52.755194bb.js"><link rel="prefetch" href="/assets/js/53.bd98d30b.js"><link rel="prefetch" href="/assets/js/54.51fa13df.js"><link rel="prefetch" href="/assets/js/55.3b27f82c.js"><link rel="prefetch" href="/assets/js/56.2d5f09af.js"><link rel="prefetch" href="/assets/js/57.59e5bf64.js"><link rel="prefetch" href="/assets/js/58.4da215bb.js"><link rel="prefetch" href="/assets/js/59.f0dd1160.js"><link rel="prefetch" href="/assets/js/6.5245781e.js"><link rel="prefetch" href="/assets/js/60.8a3a51dc.js"><link rel="prefetch" href="/assets/js/61.2d221c84.js"><link rel="prefetch" href="/assets/js/62.1efabc55.js"><link rel="prefetch" href="/assets/js/63.fad6ede3.js"><link rel="prefetch" href="/assets/js/64.16603306.js"><link rel="prefetch" href="/assets/js/65.fa49138c.js"><link rel="prefetch" href="/assets/js/66.881a3bb5.js"><link rel="prefetch" href="/assets/js/67.25cbb4cf.js"><link rel="prefetch" href="/assets/js/68.117eca53.js"><link rel="prefetch" href="/assets/js/69.053855dc.js"><link rel="prefetch" href="/assets/js/7.fc1bdbb6.js"><link rel="prefetch" href="/assets/js/70.7721e7e9.js"><link rel="prefetch" href="/assets/js/71.29a557ad.js"><link rel="prefetch" href="/assets/js/72.1a6f90ae.js"><link rel="prefetch" href="/assets/js/73.913d468a.js"><link rel="prefetch" href="/assets/js/74.96968d72.js"><link rel="prefetch" href="/assets/js/75.01b38a33.js"><link rel="prefetch" href="/assets/js/76.f82ae778.js"><link rel="prefetch" href="/assets/js/77.68514817.js"><link rel="prefetch" href="/assets/js/78.56b87e13.js"><link rel="prefetch" href="/assets/js/79.9ac9d757.js"><link rel="prefetch" href="/assets/js/8.f060be44.js"><link rel="prefetch" href="/assets/js/80.6090f235.js"><link rel="prefetch" href="/assets/js/81.7de2f01b.js"><link rel="prefetch" href="/assets/js/82.1b7be951.js"><link rel="prefetch" href="/assets/js/83.1104bfb5.js"><link rel="prefetch" href="/assets/js/84.7e0dbb84.js"><link rel="prefetch" href="/assets/js/85.abb461ec.js"><link rel="prefetch" href="/assets/js/86.2e77efbc.js"><link rel="prefetch" href="/assets/js/87.b93727f5.js"><link rel="prefetch" href="/assets/js/88.b554117b.js"><link rel="prefetch" href="/assets/js/89.c1306298.js"><link rel="prefetch" href="/assets/js/9.18126abf.js"><link rel="prefetch" href="/assets/js/90.328f05cd.js"><link rel="prefetch" href="/assets/js/91.8008e0b0.js"><link rel="prefetch" href="/assets/js/92.8b4dca37.js"><link rel="prefetch" href="/assets/js/93.9f7d7273.js"><link rel="prefetch" href="/assets/js/94.176890d0.js"><link rel="prefetch" href="/assets/js/95.a69dbea6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1cdd1db5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">游离 の Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/vuejs/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/vuejs/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Dev Ops</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev-ops/ansible.html" class="sidebar-link">ansible</a></li><li><a href="/dev-ops/docker.html" class="sidebar-link">Docker</a></li><li><a href="/dev-ops/gitlab ci.html" class="sidebar-link">Gitlab-CI</a></li><li><a href="/dev-ops/gitlab-ci踩坑.html" class="active sidebar-link">Gitlab-ci 踩坑</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev-ops/gitlab-ci踩坑.html#问题一-yarn-的时候报错" class="sidebar-link">问题一：yarn 的时候报错</a></li><li class="sidebar-sub-header"><a href="/dev-ops/gitlab-ci踩坑.html#问题二-permission-denied" class="sidebar-link">问题二：permission denied</a></li><li class="sidebar-sub-header"><a href="/dev-ops/gitlab-ci踩坑.html#问题三-配置-ssh-用户权限" class="sidebar-link">问题三：配置 ssh 用户权限</a></li><li class="sidebar-sub-header"><a href="/dev-ops/gitlab-ci踩坑.html#问题四-stage-之间文件传递" class="sidebar-link">问题四：stage 之间文件传递</a></li><li class="sidebar-sub-header"><a href="/dev-ops/gitlab-ci踩坑.html#问题五-prepare-failed" class="sidebar-link">问题五：prepare failed</a></li><li class="sidebar-sub-header"><a href="/dev-ops/gitlab-ci踩坑.html#问题六-不能用环境变量指定-artifacts-path" class="sidebar-link">问题六：不能用环境变量指定 artifacts：path</a></li><li class="sidebar-sub-header"><a href="/dev-ops/gitlab-ci踩坑.html#问题七-ssh-执行命令-显示-command-not-find" class="sidebar-link">问题七： ssh 执行命令，显示 command not find</a></li></ul></li><li><a href="/dev-ops/linux总结.html" class="sidebar-link">linux 总结</a></li><li><a href="/dev-ops/nginx.html" class="sidebar-link">nginx</a></li><li><a href="/dev-ops/ssh.html" class="sidebar-link">ssh</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gitlab-ci-踩坑"><a href="#gitlab-ci-踩坑" class="header-anchor">#</a> Gitlab-ci 踩坑</h1> <h2 id="问题一-yarn-的时候报错"><a href="#问题一-yarn-的时候报错" class="header-anchor">#</a> 问题一：<strong>yarn 的时候报错</strong></h2> <p>解决方案：yarn 之前配 yarn 源，添加 yarn config set registry ${url}</p> <h2 id="问题二-permission-denied"><a href="#问题二-permission-denied" class="header-anchor">#</a> 问题二：<strong>permission denied</strong></h2> <p>一开始是以为是密码错误，密码变量带有特殊字符，修改为用单引号包裹后还是报错。以上两个错误交替出现，最后用 sudo：yes 解决了，<strong>删除文件需要较高的权限</strong></p> <p>解决：在 ansible 的 task 上加上 sudo: yes 解决权限问题</p> <p><img src="https://i.loli.net/2021/01/06/xvVL45wmRJ9CQTS.png" alt="image-20210106215244122.png"></p> <p><img src="https://i.loli.net/2021/01/06/xvVL45wmRJ9CQTS.png" alt="image-20210106215244122"></p> <h2 id="问题三-配置-ssh-用户权限"><a href="#问题三-配置-ssh-用户权限" class="header-anchor">#</a> 问题三：配置 ssh 用户权限</h2> <p>北京：需要克隆子模块，而子模块的 url 是 ssh 地址，需要配置用户 ssh 才能 clone 仓库，采用以下配置 ssh 用户权限</p> <p>node 镜像低也会导致某些错误</p> <div class="language- extra-class"><pre class="language-text"><code>image: ${image}
script:
    - mkdir -p  ~/.ssh
    - chmod 700 ~/.ssh
    - '[[ -f /.dockerenv ]] &amp;&amp; echo -e &quot;Host *\n\tStrictHostKeyChecking no\n\n&quot; &gt; ~/.ssh/config'  #设ssh配置:每次连接一个新主机不做确认和警告
    - eval $(ssh-agent -s)  # 启动ssh-agent
    - ssh-add &lt; (echo &quot;$PRIVATE_SSH_KEY&quot;) # 添加私钥到ssh-agent代理
</code></pre></div><h2 id="问题四-stage-之间文件传递"><a href="#问题四-stage-之间文件传递" class="header-anchor">#</a> 问题四：stage 之间文件传递</h2> <p>每个 stage 是独立的，当前 stage 生成的文件会立即执行完后会立即删除，那下个 stage 要如何拿到上个 stage 的文件呢</p> <ul><li>此处有 cache 和 atifactory 两种方案对比，两者都可以传递，但是 cache 不是可靠的，只是作为优化的一种方案，不能确保两个 stage 之间一定能传递文件</li> <li>不宜传递太大的文件，而且传递的文件太大例如 node_modules,会报错</li> <li>artifacts 可以在 gitlab 的对应 pipeline 上直接点击下载，可以设置制品的过期时间<img src="https://i.loli.net/2021/01/06/xvVL45wmRJ9CQTS.png" alt="image-20210106215244122"></li></ul> <h2 id="问题五-prepare-failed"><a href="#问题五-prepare-failed" class="header-anchor">#</a> 问题五：prepare failed</h2> <p>解决：</p> <p>指定 tags 为 k8s，不指定会报错</p> <div class="language- extra-class"><pre class="language-text"><code>test1:
 stage: test1
 image: ${image}
 script:
 - mkdir dist
 - cd dist &amp;&amp; touch markdown.md &amp;&amp; cd -
 tags:
 - k8s
</code></pre></div><h2 id="问题六-不能用环境变量指定-artifacts-path"><a href="#问题六-不能用环境变量指定-artifacts-path" class="header-anchor">#</a> 问题六：不能用环境变量指定 artifacts：path</h2> <p>解决：使用通配符</p> <div class="language- extra-class"><pre class="language-text"><code>artifacts:
  - paths:
  - &quot;*.zip&quot;
</code></pre></div><h2 id="问题七-ssh-执行命令-显示-command-not-find"><a href="#问题七-ssh-执行命令-显示-command-not-find" class="header-anchor">#</a> 问题七： ssh 执行命令，显示 command not find</h2> <ul><li><p>问题：在 ssh 登录或者 ansible 登录执行命令报错显示 command not find</p></li> <li><p>原因 ： ssh 登录少了环境变量</p></li> <li><p><strong>首先了解一下 login shell 与 non-login shell</strong></p> <p>/etc/profile 及/etc/bashrc 的区别：
<strong>login shell</strong>：取得 bash 时需要完整的登入流程的，就称为 login shell。举例来说，你要由 tty1~tty6 登入，需要输入用户的账号和密码，此时取得的 bash 就称为『login shell』啰；
<strong>non-login shell</strong>：取得 bash 接口的方法不需要重复登入的举动，举例来说，(1)你以 Xwindow 登入 Linux 后，再以 X 的图形化接口启动终端机，此时那个终端接口并没有需要再次的输入账号和密码，那个 bash 的环境就称为 non-login shell 了。(2)你在原本的 bash 环境下再次下达 bash 这个命令，同样的也没有输入账号密码，那第二个 bash (子程序)也是 non-login shell 。</p></li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">-</span> mkdir ~/.ssh <span class="token punctuation">-</span>p
<span class="token punctuation">-</span> chmod 700 ~/.ssh
<span class="token punctuation">-</span> <span class="token string">'[[ -f /.dockerenv ]] &amp;&amp; echo -e &quot;Host *\n\tStrictHostKeyChecking no\n\n&quot; &gt; ~/.ssh/config'</span>
<span class="token punctuation">-</span> eval $(ssh<span class="token punctuation">-</span>agent <span class="token punctuation">-</span>s)
<span class="token punctuation">-</span> echo &quot;$PRIVATE_SSH_KEY&quot;
<span class="token punctuation">-</span> ssh<span class="token punctuation">-</span>add &lt;(echo &quot;$PRIVATE_SSH_KEY&quot;)
<span class="token punctuation">-</span> ssh <span class="token punctuation">-</span>T $<span class="token punctuation">{</span>USER<span class="token punctuation">}</span>@$<span class="token punctuation">{</span>HOST<span class="token punctuation">}</span> &quot;source ~/.bash_profile; cd $<span class="token punctuation">{</span>path<span class="token punctuation">}</span> <span class="token important">&amp;&amp;</span> yarn release&quot;
</code></pre></div><p><a href="https://www.yuque.com/plantegg/weyi1s/mysyy3#342wyn" target="_blank" rel="noopener noreferrer">测试好的脚本放到<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> crontab 里就报错: 找不到命令</p> <p><a href="https://blog.csdn.net/u010871982/article/details/78525367" target="_blank" rel="noopener noreferrer">关于 ansible 远程执行的环境变量问题（login shell &amp; nonlogin shelll）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://zhuanlan.zhihu.com/p/60914157" target="_blank" rel="noopener noreferrer">远程执行命令的填坑记录<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/vuejs/vuepress/edit/master/dev-ops/gitlab-ci踩坑.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/30/2023, 7:22:50 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dev-ops/gitlab ci.html" class="prev">
        Gitlab-CI
      </a></span> <span class="next"><a href="/dev-ops/linux总结.html">
        linux 总结
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.301264ef.js" defer></script><script src="/assets/js/2.491aa157.js" defer></script><script src="/assets/js/34.65f27a2b.js" defer></script>
  </body>
</html>
