<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gitlab-CI | 游离 の Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.1cdd1db5.css" as="style"><link rel="preload" href="/assets/js/app.301264ef.js" as="script"><link rel="preload" href="/assets/js/2.491aa157.js" as="script"><link rel="preload" href="/assets/js/33.3096cd30.js" as="script"><link rel="prefetch" href="/assets/js/10.c14c6624.js"><link rel="prefetch" href="/assets/js/11.a9937c4e.js"><link rel="prefetch" href="/assets/js/12.b046b473.js"><link rel="prefetch" href="/assets/js/13.01aa47ff.js"><link rel="prefetch" href="/assets/js/14.f42daf23.js"><link rel="prefetch" href="/assets/js/15.fb6a03fc.js"><link rel="prefetch" href="/assets/js/16.3d6029c1.js"><link rel="prefetch" href="/assets/js/17.e7fd4a45.js"><link rel="prefetch" href="/assets/js/18.2eee2a30.js"><link rel="prefetch" href="/assets/js/19.c7a805c8.js"><link rel="prefetch" href="/assets/js/20.6ec04b81.js"><link rel="prefetch" href="/assets/js/21.d6a9c37a.js"><link rel="prefetch" href="/assets/js/22.d54975c6.js"><link rel="prefetch" href="/assets/js/23.dd01fe58.js"><link rel="prefetch" href="/assets/js/24.5b080a00.js"><link rel="prefetch" href="/assets/js/25.3e3a8a4d.js"><link rel="prefetch" href="/assets/js/26.530f08ad.js"><link rel="prefetch" href="/assets/js/27.4ff6770f.js"><link rel="prefetch" href="/assets/js/28.4772ab22.js"><link rel="prefetch" href="/assets/js/29.59c92581.js"><link rel="prefetch" href="/assets/js/3.2a78adba.js"><link rel="prefetch" href="/assets/js/30.8945c40e.js"><link rel="prefetch" href="/assets/js/31.71ea1936.js"><link rel="prefetch" href="/assets/js/32.242631cf.js"><link rel="prefetch" href="/assets/js/34.65f27a2b.js"><link rel="prefetch" href="/assets/js/35.8a5e22fe.js"><link rel="prefetch" href="/assets/js/36.b8444b82.js"><link rel="prefetch" href="/assets/js/37.07333cdf.js"><link rel="prefetch" href="/assets/js/38.c9340582.js"><link rel="prefetch" href="/assets/js/39.86b27506.js"><link rel="prefetch" href="/assets/js/4.6c7e408b.js"><link rel="prefetch" href="/assets/js/40.3e8e0e91.js"><link rel="prefetch" href="/assets/js/41.4abf36b5.js"><link rel="prefetch" href="/assets/js/42.b93937ca.js"><link rel="prefetch" href="/assets/js/43.599a58a3.js"><link rel="prefetch" href="/assets/js/44.58c0ac23.js"><link rel="prefetch" href="/assets/js/45.a007e26f.js"><link rel="prefetch" href="/assets/js/46.9aebcd42.js"><link rel="prefetch" href="/assets/js/47.ac13be33.js"><link rel="prefetch" href="/assets/js/48.34e99078.js"><link rel="prefetch" href="/assets/js/49.195b0aef.js"><link rel="prefetch" href="/assets/js/5.82c6f654.js"><link rel="prefetch" href="/assets/js/50.964a51b7.js"><link rel="prefetch" href="/assets/js/51.b0b85444.js"><link rel="prefetch" href="/assets/js/52.755194bb.js"><link rel="prefetch" href="/assets/js/53.bd98d30b.js"><link rel="prefetch" href="/assets/js/54.51fa13df.js"><link rel="prefetch" href="/assets/js/55.3b27f82c.js"><link rel="prefetch" href="/assets/js/56.2d5f09af.js"><link rel="prefetch" href="/assets/js/57.59e5bf64.js"><link rel="prefetch" href="/assets/js/58.4da215bb.js"><link rel="prefetch" href="/assets/js/59.f0dd1160.js"><link rel="prefetch" href="/assets/js/6.5245781e.js"><link rel="prefetch" href="/assets/js/60.8a3a51dc.js"><link rel="prefetch" href="/assets/js/61.2d221c84.js"><link rel="prefetch" href="/assets/js/62.1efabc55.js"><link rel="prefetch" href="/assets/js/63.fad6ede3.js"><link rel="prefetch" href="/assets/js/64.16603306.js"><link rel="prefetch" href="/assets/js/65.fa49138c.js"><link rel="prefetch" href="/assets/js/66.881a3bb5.js"><link rel="prefetch" href="/assets/js/67.25cbb4cf.js"><link rel="prefetch" href="/assets/js/68.117eca53.js"><link rel="prefetch" href="/assets/js/69.053855dc.js"><link rel="prefetch" href="/assets/js/7.fc1bdbb6.js"><link rel="prefetch" href="/assets/js/70.7721e7e9.js"><link rel="prefetch" href="/assets/js/71.29a557ad.js"><link rel="prefetch" href="/assets/js/72.1a6f90ae.js"><link rel="prefetch" href="/assets/js/73.913d468a.js"><link rel="prefetch" href="/assets/js/74.96968d72.js"><link rel="prefetch" href="/assets/js/75.01b38a33.js"><link rel="prefetch" href="/assets/js/76.f82ae778.js"><link rel="prefetch" href="/assets/js/77.68514817.js"><link rel="prefetch" href="/assets/js/78.56b87e13.js"><link rel="prefetch" href="/assets/js/79.9ac9d757.js"><link rel="prefetch" href="/assets/js/8.f060be44.js"><link rel="prefetch" href="/assets/js/80.6090f235.js"><link rel="prefetch" href="/assets/js/81.7de2f01b.js"><link rel="prefetch" href="/assets/js/82.1b7be951.js"><link rel="prefetch" href="/assets/js/83.1104bfb5.js"><link rel="prefetch" href="/assets/js/84.7e0dbb84.js"><link rel="prefetch" href="/assets/js/85.abb461ec.js"><link rel="prefetch" href="/assets/js/86.2e77efbc.js"><link rel="prefetch" href="/assets/js/87.b93727f5.js"><link rel="prefetch" href="/assets/js/88.b554117b.js"><link rel="prefetch" href="/assets/js/89.c1306298.js"><link rel="prefetch" href="/assets/js/9.18126abf.js"><link rel="prefetch" href="/assets/js/90.328f05cd.js"><link rel="prefetch" href="/assets/js/91.8008e0b0.js"><link rel="prefetch" href="/assets/js/92.8b4dca37.js"><link rel="prefetch" href="/assets/js/93.9f7d7273.js"><link rel="prefetch" href="/assets/js/94.176890d0.js"><link rel="prefetch" href="/assets/js/95.a69dbea6.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1cdd1db5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">游离 の Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/vuejs/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/vuejs/vuepress" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Dev Ops</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev-ops/ansible.html" class="sidebar-link">ansible</a></li><li><a href="/dev-ops/docker.html" class="sidebar-link">Docker</a></li><li><a href="/dev-ops/gitlab ci.html" class="active sidebar-link">Gitlab-CI</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev-ops/gitlab ci.html#gitlab-ci" class="sidebar-link">Gitlab-CI</a></li><li class="sidebar-sub-header"><a href="/dev-ops/gitlab ci.html#介绍" class="sidebar-link">介绍</a></li><li class="sidebar-sub-header"><a href="/dev-ops/gitlab ci.html#gitlab-runner" class="sidebar-link">gitlab-runner</a></li><li class="sidebar-sub-header"><a href="/dev-ops/gitlab ci.html#stages" class="sidebar-link">stages</a></li><li class="sidebar-sub-header"><a href="/dev-ops/gitlab ci.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/dev-ops/gitlab-ci踩坑.html" class="sidebar-link">Gitlab-ci 踩坑</a></li><li><a href="/dev-ops/linux总结.html" class="sidebar-link">linux 总结</a></li><li><a href="/dev-ops/nginx.html" class="sidebar-link">nginx</a></li><li><a href="/dev-ops/ssh.html" class="sidebar-link">ssh</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工程化</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="gitlab-ci"><a href="#gitlab-ci" class="header-anchor">#</a> Gitlab-CI</h2> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>Gitlab CI/CD 是一款用于<a href="https://github.com/ascoders/weekly/blob/v2/101.%E7%B2%BE%E8%AF%BB%E3%80%8A%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90%20vs%20%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%20vs%20%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2%E3%80%8B.md" target="_blank" rel="noopener noreferrer">持续集成（CI），持续交付（CD）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的工具，相似的工具有 Jenkins、Travis CI、GoCD 等。</p> <ul><li>CI 即持续集成，Continuous Integration，目标：持续集成，持续测试（保证代码质量）</li> <li>CD 即持续交付，即 Continuous Delivery，目标:  持续部署（自动发布版本，供用户使用)。</li> <li>从 GitLab 8.0 开始，GitLab CI 就已经集成在 GitLab 中，我们只要在项目中添加一个 .gitlab-ci.yml 文件，然后添加一个 Runner，即可进行持续集成。</li> <li>.gitlab-ci.yml 文件使用 yaml 语法，<a href="http://www.ruanyifeng.com/blog/2016/07/yaml.html" target="_blank" rel="noopener noreferrer">语法介绍请戳<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>与 jenkins 对比</p> <ul><li>gitlab-ci 的优势在于比较配置和使用简单，能在 gitlab 上直接看到执行过程，不需要配 webhook，集成在了 gitlab 上。</li> <li>jenkins 的优势在于编译服务和代码仓库分离，而且编译配置文件不需要在工程中配置，并且 jenkins 依靠它丰富的插件，可以配置很多 gitlab-ci 不存在的功能，比如说看编译状况统计等</li></ul> <h2 id="gitlab-runner"><a href="#gitlab-runner" class="header-anchor">#</a> gitlab-runner</h2> <ul><li>gitlab 的自动化操作都是在 runner 机器中运行,我们需要注册 runner</li> <li>runner 分为 shared runner 和 specified runner.</li></ul> <h3 id="gitlab-操作"><a href="#gitlab-操作" class="header-anchor">#</a> gitlab 操作</h3> <p>gitlab 上有关 gitlab-ci 的配置有两处</p> <ul><li>一处是 CI/CD 可以查看构建任务 pipeline、job 的执行情况</li> <li>一处是 setting 里面对 ci 的设置</li></ul> <img src="https://i.loli.net/2020/12/12/IVjWRdYUlOKbCsn.png" alt="image-20201212122028807"> <ul><li><p>一次提交触发一次 CI&amp;CD 即执行一次脚本对应一个 pipeline</p></li> <li><p>一个 pipeline 对应 stages 下的所有 job</p></li> <li><p>一个 stage 可以有多个 job；</p></li></ul> <h3 id="skip-pipeline"><a href="#skip-pipeline" class="header-anchor">#</a> Skip Pipeline</h3> <ul><li>commit message 上加上[ci skip]  或者[skip ci]就可以跳过 pipeline 执行。</li> <li>在一次 git push 调用中进行多次更改时，GitLab 最多创建四个分支和标签管道。此限制不影响任何更新的合并请求管道。所有更新的合并请求在使用管道处理合并请求时都会创建一个管道。</li></ul> <h2 id="stages"><a href="#stages" class="header-anchor">#</a> stages</h2> <ul><li><p>gitlab-ci 的 pipeline 由一个个 stage 顺序执行，每个 stage 可以有多个 job</p></li> <li><p>job 是并行执行的
所有 build 的 jobs 执行成功后，commit 才会标记为 success，所有的 build 的 jobs 执行成功，</p></li> <li><p>任何一个前置的 jobs 失败了，commit 会标记为 failed 并且下一个 stages 的 jobs 都不会执行。</p></li> <li><p>默认定义为 build，test 和 deploy。</p></li> <li><p>如果一个 job 没有指定 stage，那么这个任务会分配到 test stage。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token punctuation">-</span> <span class="token key atrule">stages</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> build
    <span class="token punctuation">-</span> release_deploy
    <span class="token punctuation">-</span> dev<span class="token punctuation">-</span>deploy
    <span class="token punctuation">-</span> prod_deploy
</code></pre></div></li></ul> <h3 id="jobs"><a href="#jobs" class="header-anchor">#</a> Jobs</h3> <ul><li>.gitlab-ci.yml 允许指定无限量 jobs。</li> <li>每个 jobs 必须有一个唯一的名字，而且不能是上面提到的关键字。</li> <li>job 由一列参数来定义 jobs 的行为。</li> <li>所属同一个 stage 的 job 都是并行的</li></ul> <div class="language- extra-class"><pre class="language-text"><code>job_name:
</code></pre></div><h3 id="pages"><a href="#pages" class="header-anchor">#</a> pages</h3> <p>一个特殊的 job，用于上传静态内容到 GitLab，可用于服务于您的网站。需要满足以下条件</p> <ul><li>任何静态内容都必须放在<code>public/</code> directory. 目录</li> <li><code>artifacts</code> ：path ：<code>public/</code> 目录必须有</li></ul> <p>下面的示例只是将所有文件从项目的根目录移动到 public/目录</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">pages</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> mkdir .public
    <span class="token punctuation">-</span> cp <span class="token punctuation">-</span>r * .public
    <span class="token punctuation">-</span> mv .public public
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span> <span class="token comment"># 必须有</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> public
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> master
</code></pre></div><h3 id="script"><a href="#script" class="header-anchor">#</a> script</h3> <div class="language- extra-class"><pre class="language-text"><code>script:
	- echo &quot;📦 开始打包&quot;
	- ssh xxx@xxxxxx &quot;
        rm -rf \`ls -d /xxx/www/* | grep -v -E '\.tar\.gz$'\` &amp;&amp;
        cd /xxx/www &amp;&amp;
        tar xvzf ${PKG_NAME} &amp;&amp;
        rm ${PKG_NAME}&quot;
     # 长命令可以通过引号包裹，再用&amp;&amp;连接表示顺序执行命令
</code></pre></div><h3 id="变量-variables"><a href="#变量-variables" class="header-anchor">#</a> 变量：variables</h3> <p>变量可以被覆盖，并且是按照以下优先级依次降低</p> <ol><li><a href="https://docs.gitlab.com/ce/ci/triggers/README.html#making-use-of-trigger-variables" target="_blank" rel="noopener noreferrer">Trigger variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://docs.gitlab.com/ce/ci/pipelines/schedules.html#using-variables" target="_blank" rel="noopener noreferrer">scheduled pipeline variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and <a href="https://docs.gitlab.com/ce/ci/variables/README.html#override-a-variable-by-manually-running-a-pipeline" target="_blank" rel="noopener noreferrer">manual pipeline run variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li>Project-level <a href="https://docs.gitlab.com/ce/ci/variables/README.html#custom-environment-variables" target="_blank" rel="noopener noreferrer">variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or <a href="https://docs.gitlab.com/ce/ci/variables/README.html#protect-a-custom-variable" target="_blank" rel="noopener noreferrer">protected variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. 项目 CI 设置的变量</li> <li>Group-level <a href="https://docs.gitlab.com/ce/ci/variables/README.html#group-level-environment-variables" target="_blank" rel="noopener noreferrer">variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or <a href="https://docs.gitlab.com/ce/ci/variables/README.html#protect-a-custom-variable" target="_blank" rel="noopener noreferrer">protected variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. gitlab 分组下 CI 设置的变量</li> <li>Instance-level <a href="https://docs.gitlab.com/ce/ci/variables/README.html#instance-level-cicd-environment-variables" target="_blank" rel="noopener noreferrer">variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or <a href="https://docs.gitlab.com/ce/ci/variables/README.html#protect-a-custom-variable" target="_blank" rel="noopener noreferrer">protected variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li><a href="https://docs.gitlab.com/ce/ci/variables/README.html#inherit-environment-variables" target="_blank" rel="noopener noreferrer">Inherited environment variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li> <li><a href="https://docs.gitlab.com/ce/ci/yaml/README.html#job-variables" target="_blank" rel="noopener noreferrer">YAML 定义的 job 级别变量<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.gitlab.com/ce/ci/yaml/README.html#variables" target="_blank" rel="noopener noreferrer">YAML 定义的全局变量<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.gitlab.com/ce/ci/variables/README.html#deployment-variables" target="_blank" rel="noopener noreferrer">部署环境变量<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.gitlab.com/ce/ci/variables/README.html#predefined-variables-environment-variables" target="_blank" rel="noopener noreferrer">预定义的环境变量<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (优先级最低)</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>variables<span class="token operator">:</span>
  <span class="token constant">BUSINESS_LINE</span><span class="token operator">:</span> $<span class="token punctuation">{</span><span class="token constant">BUSINESS_LINE</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="job-的执行条件"><a href="#job-的执行条件" class="header-anchor">#</a> job 的执行条件</h3> <p>only（定义 job 执行条件）和 except（定义了 job 不被执行的条件）两个参数定义了 job 被创建的条件:</p> <ul><li><p>except 和 only 如果没有指定 name，默认是 tags 和 branches</p></li> <li><p>only 和 except 如果都存在在一个 job 声明中，则所需引用将会被 only 和 except 所定义的分支过滤.</p></li> <li><p>only 和 except 允许使用正则</p></li> <li><p>only 和 except 允许使用指定仓库地址，但是不 forks 仓库</p></li></ul> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">only</span><span class="token punctuation">:</span> <span class="token comment">#都是或者的关系</span>
   <span class="token punctuation">-</span> tags      <span class="token comment"># tag 分支 commit 之后触发</span>
   <span class="token punctuation">-</span> triggers  <span class="token comment"># API 触发</span>
   <span class="token punctuation">-</span> <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token comment"># 当你的Git Refs对应的是一个分支时触发</span>
   <span class="token punctuation">-</span> tags      <span class="token comment"># 当你的Git Refs对应的是一个标签时触发</span>
   <span class="token punctuation">-</span> pushes    <span class="token comment"># 当你使用git push时触发</span>
   <span class="token punctuation">-</span> web       <span class="token comment"># 当你使用Web界面的Run Pipeline时触发</span>
   <span class="token punctuation">-</span> merge_requests <span class="token comment">#当你创建或者更新一个merge_requests时触发</span>
   <span class="token punctuation">-</span> schedules <span class="token comment"># 每日构建触发</span>
   <span class="token punctuation">-</span> /^issue<span class="token punctuation">-</span>.<span class="token important">*$/</span> <span class="token comment"># job将会只在issue-开头的refs下执行</span>
   <span class="token punctuation">-</span> branches@gitlab<span class="token punctuation">-</span>org/gitlab<span class="token punctuation">-</span>ce  <span class="token comment">#在父仓库gitlab-org/    gitlab-ce有提交时运行。</span>
<span class="token comment"># 对分支的限制触发,只在分支是master和schedules的时候触发</span>
    <span class="token key atrule">refs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> master
      <span class="token punctuation">-</span> schedules
    <span class="token key atrule">kubernetes</span><span class="token punctuation">:</span> active
<span class="token comment"># 变量条件触发，当RELEASE变量是staging或者STAGING存在时触发</span>
    <span class="token key atrule">variables</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> $RELEASE == &quot;staging&quot;
      <span class="token punctuation">-</span> $STAGING
      <span class="token punctuation">-</span> ($CI_COMMIT_BRANCH == &quot;master&quot; <span class="token punctuation">|</span><span class="token punctuation">|</span> $CI_COMMIT_BRANCH == &quot;develop&quot;) <span class="token important">&amp;&amp;</span> $MY_VARIABLE
<span class="token comment"># 文件变化才触发</span>
    <span class="token key atrule">changes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> Dockerfile
      <span class="token punctuation">-</span> docker/scripts/*
      <span class="token punctuation">-</span> dockerfiles/<span class="token important">**/*</span>
      <span class="token punctuation">-</span> more_scripts/<span class="token important">*.</span><span class="token punctuation">{</span>rb<span class="token punctuation">,</span>py<span class="token punctuation">,</span>sh<span class="token punctuation">}</span>
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">if</span><span class="token punctuation">:</span> <span class="token string">'$CI_PIPELINE_SOURCE == &quot;merge_request_event&quot;'</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span> manual
      <span class="token key atrule">allow_failure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token punctuation">-</span> <span class="token key atrule">if</span><span class="token punctuation">:</span> <span class="token string">'$CI_PIPELINE_SOURCE == &quot;schedule&quot;'</span>
    <span class="token punctuation">-</span> <span class="token key atrule">if</span><span class="token punctuation">:</span> ($CI_COMMIT_BRANCH == &quot;master&quot; <span class="token punctuation">|</span><span class="token punctuation">|</span> $CI_COMMIT_BRANCH == &quot;develop&quot;) <span class="token important">&amp;&amp;</span> $MY_VARIABLE
</code></pre></div><p><img src="https://i.loli.net/2020/12/13/TKO5iznorx2Vv46.png" alt="image-20201213200855935"></p> <h3 id="image-services"><a href="#image-services" class="header-anchor">#</a> image/services</h3> <p>该关键字指定一个任务（job）所使用的 docker 镜像，例如<code>image: python:latest</code>使用 Python 的最新镜像。</p> <p>镜像下载的策略：</p> <ul><li>never： 当使用这个策略，会禁止 Gitlab Runner 从 Docker hub 或者其他地方下拉镜像，只能使用自己手动下拉的镜像</li> <li>if-not-present： 当使用这个策略，Runner 会先检测本地是否有镜像，有的话使用该镜像，如果没有再去下拉。这个策略如果再配合定期删除镜像，就能达到比较好的效果。</li> <li>always： 这个是 gitlab-ci 默认使用的策略，即每一次都是重新下拉镜像，导致的结果就是比较耗时间</li></ul> <h3 id="artifacts"><a href="#artifacts" class="header-anchor">#</a> artifacts</h3> <p>artifacts 被用于在 job 作业成功后将制定列表里的文件或文件夹附加到 job 上，传递给下一个 job ，如果要在两个 job 之间传递 artifacts，你必须设置 dependencies,下面有几个例子</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;$CI_JOB_NAME&quot;</span> <span class="token comment"># artifacts压缩包重命名</span>
  <span class="token key atrule">untracked</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 传递所有git没有追踪的文件</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span> on_failure <span class="token comment"># 当job执行失败时，上传artifacts,还有on_success 这个值是默认的，当job成功时上传artifacts。always 不管失败与否，都上传</span>
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span> expire_in <span class="token comment"># 设置 artifacts 上传包的失效时间. 如果不设置，artifacts 的打包是永远存在于 gitlab上 的，'3 mins 4 sec','2 hrs 20 min','2h20min','6 mos 1 day','47 yrs 6 mos and 4d','3 weeks and 2 days'</span>
  <span class="token key atrule">paths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> binaries/ <span class="token comment">#传递所有binaries和.config：</span>
    <span class="token punctuation">-</span> .config
</code></pre></div><h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p><a href="https://juejin.cn/post/6844904045581172744#heading-11" target="_blank" rel="noopener noreferrer">Gitlab-CI 使用教程<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://docs.gitlab.com/ee/ci/README.html" target="_blank" rel="noopener noreferrer">Gitlab-ci-官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/vuejs/vuepress/edit/master/dev-ops/gitlab ci.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/30/2023, 7:22:50 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dev-ops/docker.html" class="prev">
        Docker
      </a></span> <span class="next"><a href="/dev-ops/gitlab-ci踩坑.html">
        Gitlab-ci 踩坑
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.301264ef.js" defer></script><script src="/assets/js/2.491aa157.js" defer></script><script src="/assets/js/33.3096cd30.js" defer></script>
  </body>
</html>
