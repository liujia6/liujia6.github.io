(window.webpackJsonp=window.webpackJsonp||[]).push([[49],{515:function(e,t,r){"use strict";r.r(t);var n=r(22),a=Object(n.a)({},(function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[r("h1",{attrs:{id:"oauth2-0-与小程序登陆"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#oauth2-0-与小程序登陆"}},[e._v("#")]),e._v(" OAuth2.0 与小程序登陆")]),e._v(" "),r("ul",[r("li",[r("p",[r("a",{attrs:{href:"https://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("OAuth"),r("OutboundLink")],1),e._v("2.0 是一种授权机制（Authorization），主要授权颁发令牌（token）")])]),e._v(" "),r("li",[r("p",[e._v("区分认证和授权")]),e._v(" "),r("ul",[r("li",[e._v("身份认证是指的通过密码或者手机号直接登陆")]),e._v(" "),r("li",[e._v("授权是指登陆后授予权限获取某些信息")])])]),e._v(" "),r("li",[r("p",[e._v("OAuth2.0 是互联网行业一种标准的授权方式。各个公司根据这一套标准实现自己的 OAuth 认证和授权流程，而第三方想要接入这个流程，就需要使用 OAuth 这套方案。")])])]),e._v(" "),r("h2",{attrs:{id:"授权登陆和认证登陆的区别"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#授权登陆和认证登陆的区别"}},[e._v("#")]),e._v(" 授权登陆和认证登陆的区别")]),e._v(" "),r("p",[e._v("数据的所有者告诉系统，同意授权第三方应用进入系统，获取这些数据。系统从而产生一个短期的进入令牌（token），用来代替密码，供第三方应用使用。")]),e._v(" "),r("p",[e._v("使用令牌相较密码的好处如下")]),e._v(" "),r("ol",[r("li",[r("p",[e._v("令牌的限制")]),e._v(" "),r("ol",[r("li",[e._v("短期，到期失效")]),e._v(" "),r("li",[e._v("数据所有者拥有对令牌的控制权，如果被撤销，会立即失效")]),e._v(" "),r("li",[e._v("有数据权限范围，例如只读和读写令牌。密码是完整权限")])])]),e._v(" "),r("li",[r("p",[e._v("令牌随时可控，不会危及系统安全")])])]),e._v(" "),r("h2",{attrs:{id:"授权机制设计"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#授权机制设计"}},[e._v("#")]),e._v(" 授权机制设计")]),e._v(" "),r("ol",[r("li",[e._v("用户申请授权")]),e._v(" "),r("li",[e._v("第三方应用确认同意授权")]),e._v(" "),r("li",[e._v("确认后给用户一个有效令牌 token（使用该 token，可以在一定期限内直接获取登陆后的数据（qq 等的数据））")])]),e._v(" "),r("h2",{attrs:{id:"通过授权码授权"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#通过授权码授权"}},[e._v("#")]),e._v(" 通过授权码授权")]),e._v(" "),r("p",[e._v("授权机制有四种方式实现，具体见"),r("a",{attrs:{href:"https://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("理解OAuth 2.0"),r("OutboundLink")],1),e._v("，其中最常用的是通过授权码授权，以下介绍通过授权码授权的方式")]),e._v(" "),r("p",[e._v("具体流程：用户申请授权码，前端申请获取授权码并使用授权码调用后端接口获取令牌")]),e._v(" "),r("h3",{attrs:{id:"好处"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#好处"}},[e._v("#")]),e._v(" 好处")]),e._v(" "),r("ul",[r("li",[e._v("避免直接在前端获取令牌，提高安全性")]),e._v(" "),r("li",[e._v("授权码通过前端传送（在前端申请获取）")]),e._v(" "),r("li",[e._v("令牌存储在后端，且所有与资源服务器的通信都在后端完成")])]),e._v(" "),r("p",[r("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2022/jpeg/2198140/1658757044553-34941f36-1e6e-4e4e-946b-c7ef01ba04a5.jpeg",alt:"img"}})]),e._v(" "),r("h2",{attrs:{id:"小程序登陆"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#小程序登陆"}},[e._v("#")]),e._v(" 小程序登陆")]),e._v(" "),r("p",[e._v("小程序登录也是是使用 OAuth2 授权码授权实现的，相比较标准的授权码Auth2.0登录而言，通过微信的API静默授权获取code，免去了跳转第三方网站授权操作的过程")]),e._v(" "),r("p",[r("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2022/png/2198140/1658931940510-187c8044-b1f2-4db5-8515-a17ad48292e6.png",alt:"img"}})]),e._v(" "),r("h3",{attrs:{id:"说明"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#说明"}},[e._v("#")]),e._v(" 说明")]),e._v(" "),r("ol",[r("li",[e._v("调用 "),r("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("wx.login()"),r("OutboundLink")],1),e._v(" 获取 "),r("strong",[e._v("临时登录凭证 code")]),e._v(" （code 只能使用一次），并回传到开发者服务器。")]),e._v(" "),r("li",[e._v("后端调用 "),r("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("auth.code2Session"),r("OutboundLink")],1),e._v(" 接口，用 code 换取 用户唯一标识 OpenID 、 用户在微信开放平台帐号下的唯一标识 UnionID（若当前小程序已绑定到微信开放平台帐号） 和 会话密钥 session_key。")]),e._v(" "),r("li",[e._v("会话密钥 session_key 是对用户数据进行 "),r("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("加密签名"),r("OutboundLink")],1),e._v(" 的密钥。为了应用自身的数据安全，开发者服务器"),r("strong",[e._v("不应该把会话密钥下发到小程序，也不应该对外提供这个密钥")]),e._v("。\n"),r("ol",[r("li",[e._v("每次调用 wx.login 后之前到 session_key 会失效，前端可以调用 checkSession 方法校验 session_key 是否有效")]),e._v(" "),r("li",[e._v("wx.getUserInfo()API 获取用户信息会返回的 encryptedData 和 iv，这是加密后到用户数据，需要使用 session_key 解密信息")]),e._v(" "),r("li",[e._v("前端将 encryptedData 和 iv 传递给后端获取私密信息，不传递 session_key")])])]),e._v(" "),r("li",[e._v("自定登录态与 openid 和 session_key 关联，实际就是生成一个与 openid，session_key 关联的 token，下发给前端")])]),e._v(" "),r("h2",{attrs:{id:"参考"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[e._v("#")]),e._v(" 参考")]),e._v(" "),r("p",[r("a",{attrs:{href:"https://segmentfault.com/a/1190000040700415",target:"_blank",rel:"noopener noreferrer"}},[e._v("github oauth 第三方认证登录"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"https://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("理解 OAuth 2.0 - 阮一峰的网络日志"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"http://www.alloyteam.com/2021/04/15431/",target:"_blank",rel:"noopener noreferrer"}},[e._v("走向匿名化，谈谈微信小程序新授权登录 | AlloyTeam"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("小程序登录 | 微信开放文档"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"https://cloud.tencent.com/developer/article/1766827",target:"_blank",rel:"noopener noreferrer"}},[e._v("一文详解小程序授权、登录、session_key 和 unionId - 腾讯云开发者社区-腾讯云"),r("OutboundLink")],1)]),e._v(" "),r("p",[r("a",{attrs:{href:"https://developers.weixin.qq.com/community/develop/doc/000c2424654c40bd9c960e71e5b009?highline=Session",target:"_blank",rel:"noopener noreferrer"}},[e._v("(4)获取用户信息 | 微信开放社区"),r("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=a.exports}}]);